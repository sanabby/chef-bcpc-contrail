################################################
#
#              Generated by Chef
#
################################################

global_defs {
  router_id <%=node['hostname']%>
}

vrrp_script chk_haproxy {
  script "killall -0 haproxy"
  interval 5
  fall 3
  rise 1
}

vrrp_script chk_quorum {
  script "<%=@chk_quorum_script%>"
  interval 5
  fall 3
  rise 1
}

vrrp_sync_group VG1_<%=@group_name%> {
  group {
    VI1_<%=@group_name%>
  }
}

vrrp_instance VI1_<%=@group_name%> {
  virtual_router_id <%=get_config(@router_id_key)%>

  # for electing MASTER, highest priority wins.
  priority  <%= 255-node['bcpc']['node_number'].to_i %>
  state     BACKUP
  nopreempt

  interface <%= node['bcpc']['management']['interface'] %>

  virtual_ipaddress {
    <%=@vip%>/<%="#{(node['bcpc']['management']['cidr'].match /\d+\.\d+\.\d+\.\d+\/(\d+)/)[1].to_i}"%>
  }
  track_script {
<% if node['bcpc']['enabled']['keepalived_checks'] then -%>
    chk_haproxy
    chk_quorum
<% end -%>
  }
  authentication {
    auth_type PASS
    auth_pass <%=get_config(@password_key)%>
  }
}
